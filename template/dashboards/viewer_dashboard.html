{% extends 'base.html' %}
{% load static %}

{% block title %}Climate Dashboard - EarthScape Climate Agency{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .metric-card {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-left: 4px solid var(--climate-primary);
    }
    
    .alert-card {
        border-left: 4px solid #ffc107;
    }
    
    .chart-container {
        height: 400px;
        position: relative;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .status-active { background-color: #28a745; }
    .status-warning { background-color: #ffc107; }
    .status-danger { background-color: #dc3545; }
    
    .weather-icon {
        font-size: 2.5rem;
        color: var(--climate-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-tachometer-alt text-climate-primary me-2"></i>
                        Climate Dashboard
                    </h1>
                    <p class="text-muted mb-0">
                        Welcome back, {{ user.get_full_name|default:user.username }}! 
                        Here's your climate data overview.
                    </p>
                </div>
                <div class="text-end">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Last updated: <span id="last-updated">{{ "now"|date:"M d, Y H:i" }}</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Row -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card dashboard-card metric-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-thermometer-half weather-icon"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="card-title mb-1">Global Temperature</h6>
                            <h4 class="mb-0 text-climate-primary">+1.1°C</h4>
                            <small class="text-muted">Above pre-industrial</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card dashboard-card metric-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-cloud weather-icon"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="card-title mb-1">CO₂ Levels</h6>
                            <h4 class="mb-0 text-warning">421 ppm</h4>
                            <small class="text-muted">Atmospheric concentration</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card dashboard-card metric-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-water weather-icon"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="card-title mb-1">Sea Level</h6>
                            <h4 class="mb-0 text-info">+3.4 mm/yr</h4>
                            <small class="text-muted">Rate of rise</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card dashboard-card metric-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-snowflake weather-icon"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="card-title mb-1">Arctic Ice</h6>
                            <h4 class="mb-0 text-danger">-13%</h4>
                            <small class="text-muted">Per decade decline</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Data Row -->
    <div class="row mb-4">
        <!-- Temperature Trend Chart -->
        <div class="col-lg-8 mb-4">
            <div class="card dashboard-card h-100">
                <div class="card-header bg-transparent border-0 pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>Temperature Trends (Last 30 Days)
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary active" data-period="30">30D</button>
                            <button type="button" class="btn btn-outline-secondary" data-period="90">90D</button>
                            <button type="button" class="btn btn-outline-secondary" data-period="365">1Y</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Alerts -->
        <div class="col-lg-4 mb-4">
            <div class="card dashboard-card h-100">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Active Alerts
                    </h5>
                </div>
                <div class="card-body">
                    {% if active_alerts %}
                        {% for alert in active_alerts %}
                        <div class="alert alert-{{ alert.severity }} alert-dismissible fade show mb-2" role="alert">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    {% if alert.severity == 'high' %}
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                    {% elif alert.severity == 'medium' %}
                                        <i class="fas fa-info-circle text-info"></i>
                                    {% else %}
                                        <i class="fas fa-bell text-secondary"></i>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1 ms-2">
                                    <h6 class="alert-heading mb-1">{{ alert.title }}</h6>
                                    <p class="mb-1 small">{{ alert.description|truncatewords:15 }}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>{{ alert.created_at|timesince }} ago
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                            <h6 class="mt-3 mb-2">All Clear</h6>
                            <p class="text-muted small">No active alerts at this time.</p>
                        </div>
                    {% endif %}
                    
                    <div class="text-center mt-3">
                        <a href="{% url 'alerts' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye me-1"></i>View All Alerts
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Sources and System Status -->
    <div class="row mb-4">
        <!-- Data Sources Map -->
        <div class="col-lg-8 mb-4">
            <div class="card dashboard-card h-100">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-map-marked-alt me-2"></i>Active Data Sources
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for source in data_sources|slice:":6" %}
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center p-2 bg-light rounded">
                                <div class="flex-shrink-0">
                                    <span class="status-indicator status-active"></span>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ source.name }}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        {{ source.location_lat|floatformat:2 }}, {{ source.location_lon|floatformat:2 }}
                                    </small>
                                    <br>
                                    <small class="text-muted">{{ source.get_source_type_display }}</small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-4">
                            <i class="fas fa-satellite text-muted" style="font-size: 3rem;"></i>
                            <h6 class="mt-3 mb-2">No Data Sources</h6>
                            <p class="text-muted small">Data sources will appear here once configured.</p>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if data_sources|length > 6 %}
                    <div class="text-center mt-3">
                        <a href="{% url 'data_sources' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye me-1"></i>View All Sources ({{ data_sources|length }})
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="col-lg-4 mb-4">
            <div class="card dashboard-card h-100">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'climate_data' %}" class="btn btn-outline-primary">
                            <i class="fas fa-database me-2"></i>View Climate Data
                        </a>
                        
                        <a href="{% url 'alerts' %}" class="btn btn-outline-warning">
                            <i class="fas fa-bell me-2"></i>Check Alerts
                        </a>
                        
                        <a href="{% url 'support_tickets' %}" class="btn btn-outline-info">
                            <i class="fas fa-life-ring me-2"></i>Get Support
                        </a>
                        
                        <a href="{% url 'profile' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-user-cog me-2"></i>Update Profile
                        </a>
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- System Status -->
                    <div class="text-center">
                        <h6 class="mb-2">System Status</h6>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small>Data Processing</small>
                            <span class="status-indicator status-active"></span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small>Alert System</small>
                            <span class="status-indicator status-active"></span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small>API Services</small>
                            <span class="status-indicator status-active"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Recent Climate Data
                    </h5>
                </div>
                <div class="card-body">
                    {% if temperature_data %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Data Type</th>
                                    <th>Value</th>
                                    <th>Source</th>
                                    <th>Timestamp</th>
                                    <th>Quality</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in temperature_data|slice:":10" %}
                                <tr>
                                    <td>
                                        <i class="fas fa-thermometer-half me-2"></i>
                                        {{ data.get_data_type_display }}
                                    </td>
                                    <td>
                                        <strong>{{ data.value }} {{ data.unit }}</strong>
                                        {% if data.is_anomaly %}
                                        <span class="badge bg-warning ms-1">Anomaly</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ data.data_source.name }}</td>
                                    <td>{{ data.timestamp|date:"M d, H:i" }}</td>
                                    <td>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-success" 
                                                 style="width: {{ data.quality_score|floatformat:0|add:"0" }}%"></div>
                                        </div>
                                        <small class="text-muted">{{ data.quality_score|floatformat:1 }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line text-muted" style="font-size: 3rem;"></i>
                        <h6 class="mt-3 mb-2">No Recent Data</h6>
                        <p class="text-muted small">Climate data will appear here once available.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize temperature chart
    const ctx = document.getElementById('temperatureChart').getContext('2d');
    
    // Sample data - in production, this would come from the API
    const temperatureChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: 30}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (29 - i));
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }),
            datasets: [{
                label: 'Global Temperature Anomaly (°C)',
                data: Array.from({length: 30}, () => (Math.random() - 0.5) * 2 + 1.1),
                borderColor: '#2E8B57',
                backgroundColor: 'rgba(46, 139, 87, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Temperature Anomaly (°C)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                }
            }
        }
    });
    
    // Period selector functionality
    document.querySelectorAll('[data-period]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // In production, this would fetch new data based on the period
            console.log('Loading data for period:', this.dataset.period);
        });
    });
    
    // Auto-refresh last updated time
    setInterval(function() {
        document.getElementById('last-updated').textContent = new Date().toLocaleString();
    }, 60000); // Update every minute
});
</script>
{% endblock %}