{% extends 'base.html' %}

{% block title %}Create Support Ticket - EarthScape Climate Agency{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .priority-option {
        border: 2px solid transparent;
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .priority-option:hover {
        border-color: var(--climate-primary);
        background-color: rgba(46, 139, 87, 0.05);
    }
    .priority-option.selected {
        border-color: var(--climate-primary);
        background-color: rgba(46, 139, 87, 0.1);
    }
    .priority-low { border-left: 4px solid #28a745; }
    .priority-medium { border-left: 4px solid #ffc107; }
    .priority-high { border-left: 4px solid #fd7e14; }
    .priority-urgent { border-left: 4px solid #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-climate-primary">
                        <i class="fas fa-plus-circle me-2"></i>Create Support Ticket
                    </h1>
                    <p class="text-muted mb-0">Submit a support request for technical assistance</p>
                </div>
                <div>
                    <a href="{% url 'support_tickets' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Tickets
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Guidelines -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h6 class="alert-heading">
                    <i class="fas fa-info-circle me-2"></i>Before Creating a Ticket
                </h6>
                <p class="mb-2">To help us assist you better, please:</p>
                <ul class="mb-0">
                    <li>Provide a clear and descriptive title</li>
                    <li>Include detailed steps to reproduce the issue</li>
                    <li>Mention any error messages you encountered</li>
                    <li>Select the appropriate priority level</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Create Ticket Form -->
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card card-climate">
                <div class="card-header bg-climate-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-edit me-2"></i>Ticket Information
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="ticketForm">
                        {% csrf_token %}
                        
                        <!-- Basic Information Section -->
                        <div class="form-section">
                            <h6 class="text-climate-primary mb-3">
                                <i class="fas fa-info me-2"></i>Basic Information
                            </h6>
                            
                            <div class="mb-3">
                                <label for="title" class="form-label">
                                    Ticket Title <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="title" name="title" required
                                       placeholder="Brief description of the issue">
                                <div class="form-text">Provide a clear, concise title that summarizes your issue</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="description" class="form-label">
                                    Detailed Description <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" id="description" name="description" rows="6" required
                                          placeholder="Please provide a detailed description of your issue, including steps to reproduce, expected behavior, and any error messages..."></textarea>
                                <div class="form-text">Include as much detail as possible to help us understand and resolve your issue</div>
                            </div>
                        </div>

                        <!-- Priority Selection Section -->
                        <div class="form-section">
                            <h6 class="text-climate-primary mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>Priority Level
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="priority-option priority-low" onclick="selectPriority('low')">
                                        <input type="radio" name="priority" value="low" id="priority-low" class="d-none">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-info-circle fa-2x text-success me-3"></i>
                                            <div>
                                                <h6 class="mb-1">Low Priority</h6>
                                                <small class="text-muted">General questions, feature requests</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="priority-option priority-medium selected" onclick="selectPriority('medium')">
                                        <input type="radio" name="priority" value="medium" id="priority-medium" class="d-none" checked>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-exclamation-circle fa-2x text-warning me-3"></i>
                                            <div>
                                                <h6 class="mb-1">Medium Priority</h6>
                                                <small class="text-muted">Non-critical issues, minor bugs</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="priority-option priority-high" onclick="selectPriority('high')">
                                        <input type="radio" name="priority" value="high" id="priority-high" class="d-none">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-exclamation-triangle fa-2x text-danger me-3"></i>
                                            <div>
                                                <h6 class="mb-1">High Priority</h6>
                                                <small class="text-muted">System errors, data access issues</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="priority-option priority-urgent" onclick="selectPriority('urgent')">
                                        <input type="radio" name="priority" value="urgent" id="priority-urgent" class="d-none">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-fire fa-2x text-danger me-3"></i>
                                            <div>
                                                <h6 class="mb-1">Urgent</h6>
                                                <small class="text-muted">Critical system failures, security issues</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information Section -->
                        <div class="form-section">
                            <h6 class="text-climate-primary mb-3">
                                <i class="fas fa-cogs me-2"></i>Additional Information
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="category" class="form-label">Issue Category</label>
                                    <select class="form-select" id="category" name="category">
                                        <option value="">Select a category</option>
                                        <option value="data_access">Data Access</option>
                                        <option value="system_error">System Error</option>
                                        <option value="account_issue">Account Issue</option>
                                        <option value="feature_request">Feature Request</option>
                                        <option value="data_quality">Data Quality</option>
                                        <option value="performance">Performance Issue</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="affected_system" class="form-label">Affected System</label>
                                    <select class="form-select" id="affected_system" name="affected_system">
                                        <option value="">Select system</option>
                                        <option value="dashboard">Dashboard</option>
                                        <option value="data_sources">Data Sources</option>
                                        <option value="climate_data">Climate Data</option>
                                        <option value="alerts">Alert System</option>
                                        <option value="api">API Access</option>
                                        <option value="authentication">Authentication</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="browser_info" class="form-label">Browser/System Information</label>
                                <input type="text" class="form-control" id="browser_info" name="browser_info" 
                                       placeholder="e.g., Chrome 91.0, Windows 10">
                                <div class="form-text">Optional: Include browser version and operating system</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="error_message" class="form-label">Error Message (if any)</label>
                                <textarea class="form-control" id="error_message" name="error_message" rows="3"
                                          placeholder="Copy and paste any error messages you received"></textarea>
                            </div>
                        </div>

                        <!-- Contact Preferences -->
                        <div class="form-section">
                            <h6 class="text-climate-primary mb-3">
                                <i class="fas fa-envelope me-2"></i>Contact Information
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="contact_email" class="form-label">Contact Email</label>
                                    <input type="email" class="form-control" id="contact_email" name="contact_email" 
                                           value="{{ user.email }}" readonly>
                                    <div class="form-text">We'll use this email for updates on your ticket</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="preferred_contact" class="form-label">Preferred Contact Method</label>
                                    <select class="form-select" id="preferred_contact" name="preferred_contact">
                                        <option value="email">Email</option>
                                        <option value="phone">Phone</option>
                                        <option value="system">System Notification</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="fas fa-undo me-1"></i>Reset Form
                            </button>
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2" onclick="saveDraft()">
                                    <i class="fas fa-save me-1"></i>Save Draft
                                </button>
                                <button type="submit" class="btn btn-climate-primary">
                                    <i class="fas fa-paper-plane me-1"></i>Submit Ticket
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function selectPriority(priority) {
    // Remove selected class from all options
    document.querySelectorAll('.priority-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Add selected class to clicked option
    document.querySelector(`.priority-${priority}`).classList.add('selected');
    
    // Check the corresponding radio button
    document.getElementById(`priority-${priority}`).checked = true;
}

function resetForm() {
    if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
        document.getElementById('ticketForm').reset();
        // Reset priority selection to medium
        selectPriority('medium');
    }
}

function saveDraft() {
    alert('Save draft functionality coming soon!\n\nThis will allow you to save your progress and continue later.');
}

// Auto-save draft every 2 minutes
let autoSaveInterval = setInterval(() => {
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    
    if (title.trim() || description.trim()) {
        console.log('Auto-saving draft...');
        // Here you would implement the actual auto-save functionality
    }
}, 120000);

// Form validation
document.getElementById('ticketForm').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('description').value.trim();
    
    if (!title || !description) {
        e.preventDefault();
        alert('Please fill in both the title and description fields.');
        return false;
    }
    
    if (title.length < 10) {
        e.preventDefault();
        alert('Please provide a more descriptive title (at least 10 characters).');
        return false;
    }
    
    if (description.length < 20) {
        e.preventDefault();
        alert('Please provide a more detailed description (at least 20 characters).');
        return false;
    }
    
    return true;
});

// Character counters
document.getElementById('title').addEventListener('input', function() {
    const length = this.value.length;
    const maxLength = 200;
    if (length > maxLength - 20) {
        this.style.borderColor = length > maxLength ? '#dc3545' : '#ffc107';
    } else {
        this.style.borderColor = '';
    }
});

document.getElementById('description').addEventListener('input', function() {
    const length = this.value.length;
    const maxLength = 2000;
    if (length > maxLength - 100) {
        this.style.borderColor = length > maxLength ? '#dc3545' : '#ffc107';
    } else {
        this.style.borderColor = '';
    }
});
</script>
{% endblock %}